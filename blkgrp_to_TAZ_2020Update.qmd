---
title: "Merging Blocks and TAZs"
author: "Author Goes Here"
date: "`r Sys.Date()`"
format: 
  html: 
    self-contained: true
editor: visual
---

## Goal

We want a way to allocate census information into TAZs. TAZs are made up of census blocks, but sometimes split the blocks. We want to create a table that gives us a way to allocate census factors into TAZs.

### Set up Packages

```{r}
library(tidyverse)
library(tidycensus)
library(tigris)
library(mapview)
library(sf)
```

## Load shapes

```{r}
#| results: hide
 
#Load TAZ shapes
TAZ <- sf::read_sf("J:/Shared drives/Data_Requests/TAZ_Shapefiles/R_Script/out/geopackage/TAZ19.gpkg") %>% 
  st_transform(26986) %>% 
  filter(STATE == "MA") #%>% # Filtering to only in MA
TAZ$TAZ_area <- st_area(TAZ)
  #filter(ID == 4398) # Filtering for one example
# intersect them
# bring in building footprints
# find number of structures in each intersection
# also want to do share of land area--remove water?
# summarize
# output


# Load census block groups (other geography) tigris::block_groups()
cbtrue <- tigris::block_groups(state = "MA", cb = TRUE, year = 2020)%>% 
  st_transform(26986)
cbfalse <- tigris::block_groups(state = "MA", cb = FALSE, year = 2020) %>% 
  st_transform(26986)

#mapview(cbfalse) + mapview(TAZ, col.regions = "red") #+ mapview(cbtrue, col.regions = "yellow")

# cbfalse looks like it more closely follows the TAZ geometry


# massgis census: https://www.mass.gov/info-details/massgis-data-2020-us-census

#massgis rooftops: https://www.mass.gov/info-details/massgis-data-building-structures-2-d
# rooftops <- st_read("data/base/STRUCTURES_POLY.shp")
# 
# saveRDS(rooftops, "data/processed/rooftops.rds")






# problems that might come up. TAZ to census boundaries might be different (like microscopically different).

# find out which "block" shapes are used to create TAZs
# tiger/cartographic/state via massGIS.

# SPA give the TAZ geometry.
```

## Perform Intersections

### Intersections

```{r}
intersections <- st_intersection(TAZ, cbfalse)
intersections$intersect_area <- st_area(intersections)
# Trying it out with a subset
# ss_intersection <- intersections %>% 
#   filter(ID == 4398) %>% 
#   st_as_sf() 
# ss_intersection$area <- st_area(ss_intersection)
# ss_intersection$pct_intersect <- ss_intersection$area / max(ss_intersection$area)
# 
# ss_intersection_final <- ss_intersection %>% 
#   filter(as.vector(pct_intersect) > 0.01)
# 
# plot(st_geometry(ss_intersection_final))

# Only keeping intersection areas for a TAZ that is at least 1% of the TAZ area 
# (could also make it 1% of the largest intersection area)
intersections_clean <- intersections %>% 
  group_by(ID) %>% 
  mutate(pct_intersect = intersect_area / TAZ_area ) %>% 
  filter(as.vector(pct_intersect) > 0.01) %>% 
  ungroup() %>% 
  rowid_to_column("Intersection_ID")

```

### Different Method for Doing Intersections

```{r}
intersections_2 <- st_join(TAZ, cbfalse, 
                           join = st_intersects, 
                           largest = TRUE)
mapview(intersections_2) + mapview(TAZ)

# This method is not correct because it only pairs one TAZ with one block group, and also does not result in the geometry of the intersection, only the TAZ
```

### Look at Rooftop Share

```{r}
rooftops <- read_rds("data/processed/rooftops.rds")
plot(st_geometry(head(rooftops,1)))

#intersecting the rooftops with the census block groups
roofs_in_bg <- st_intersection(cbfalse, rooftops)

# finding the number of rooftops in each census block group
num_rooftops <- roofs_in_bg %>% 
  group_by(GEOID) %>% 
  mutate(num_roof = n()) %>%  
  distinct(GEOID, num_roof)

saveRDS(roofs_in_bg, "data/processed/rooftops_in_bg.rds")
saveRDS(num_rooftops, "data/processed/num_rooftops.rds")



# Joining the intersection areas with the rooftops that reside inside of them

roofs_in_intersect <- st_join(intersections_clean, rooftops)

# This below ran for 15+ minutes and then crashed
num_rooftops_intersect <- roofs_in_intersect %>% 
  group_by(Intersection_ID) %>% 
  mutate(num_roof = n()) %>% 
  distinct(Intersection_ID, ID, GEOID, num_roof)

saveRDS(roofs_in_intersect, "data/processed/rooftops_in_intersect.rds")
saveRDS(num_rooftops_intersect, "data/processed/num_rooftops_intersect.rds")
```

### Look at Area Share

```{r}

```

## Testing

### Test minority share

```{r}

# downloaded from: https://data.census.gov/table?t=Race+and+Ethnicity&g=0400000US25$1500000&tid=DECENNIALPL2020.P1
minority <- read_csv("data/base/DECENNIALPL2020.P1-Data.csv")

```

Thoughts:

-   some TAZs are smaller than blockgroups. Do we need to adjust the method of analysis for those cases? It could be the same. Since we are looking for the percentage of the block group that is within the TAZ, then it wouldn't matter if it is smaller or larger. In this case, it just wouldn't also be sharing area with other block groups.

    ![](images/image-779890944.png)

-   There are 17,000 intersection areas, meaning that the boundaries probably don't add up. Brought it down to 8843 by taking out the smallest intersection areas

-   Anything with the rooftops takes a very long time

-   the number of census block groups goes from 5116 to 5110, meaning there are 6 block groups with no rooftops. Also does not take into account if there are rooftops that intersect multiple blockgroups. For some reason, there are less unique IDs in roofs_in_cb than there are in rooftops, but the sum in num_rooftops is the same as the number of entries in roofs_in_cb
